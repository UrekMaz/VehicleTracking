<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* --- Your existing CSS from previous code --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; height: 100vh; overflow: hidden; background: #f3f4f6; }
    .sidebar { width: 380px; background: white; box-shadow: 2px 0 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; z-index: 1000; }
    .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 24px; }
    .header h1 { font-size: 24px; font-weight: bold; margin-bottom: 16px; }
    .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .stat-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 8px; padding: 12px; }
    .stat-label { font-size: 11px; color: #bfdbfe; margin-bottom: 4px; }
    .stat-value { font-size: 24px; font-weight: bold; }
    .alerts { display: flex; gap: 8px; flex-wrap: wrap; }
    .alert-badge { background: rgba(239, 68, 68, 0.2); backdrop-filter: blur(10px); border-radius: 6px; padding: 6px 12px; font-size: 13px; }
    .alert-badge.warning { background: rgba(245, 158, 11, 0.2); }
    .vehicle-list { flex: 1; overflow-y: auto; padding: 16px; }
    .vehicle-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
    .vehicle-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-1px); }
    .vehicle-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .vehicle-info { display: flex; align-items: center; gap: 8px; }
    .vehicle-icon { width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #2563eb; }
    .vehicle-id { font-weight: 600; font-size: 15px; color: #111827; }
    .status-badge { font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 12px; border: 1px solid; }
    .status-active { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .status-warning { background: #fef3c7; color: #92400e; border-color: #fde68a; }
    .status-critical { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
    .vehicle-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .stat-item { display: flex; align-items: center; gap: 8px; }
    .stat-icon { width: 16px; height: 16px; color: #6b7280; }
    .stat-content { flex: 1; }
    .stat-content label { display: block; font-size: 11px; color: #6b7280; margin-bottom: 2px; }
    .stat-content value { display: block; font-size: 14px; font-weight: 600; color: #111827; }
    .timestamp { font-size: 11px; color: #9ca3af; margin-top: 12px; text-align: right; }
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    .loading { display: flex; align-items: center; justify-content: center; padding: 48px; }
    .spinner { width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: #2563eb; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .map-controls { position: absolute; bottom: 24px; right: 24px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); overflow: hidden; z-index: 1000; }
    .map-controls button { display: block; width: 40px; height: 40px; border: none; background: white; cursor: pointer; font-size: 20px; font-weight: bold; color: #374151; transition: background 0.2s; }
    .map-controls button:hover { background: #f3f4f6; }
    .map-controls button:first-child { border-bottom: 1px solid #e5e7eb; }
    .live-indicator { position: absolute; top: 24px; right: 24px; background: white; padding: 12px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 8px; z-index: 1000; }
    .live-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .live-text { font-size: 14px; font-weight: 500; color: #374151; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="header">
      <h1>Vehicle Tracker</h1>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Total Vehicles</div>
          <div class="stat-value" id="totalVehicles">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Active</div>
          <div class="stat-value" id="activeVehicles">0</div>
        </div>
      </div>
      <div class="alerts" id="alerts"></div>
    </div>

    <!-- Vehicle list -->
    <div class="vehicle-list" id="vehicleList">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>

    <!-- Route controls -->
    <div style="padding: 16px; border-top: 1px solid #e5e7eb;">
      <label for="vehicleSelect" style="font-weight: 600; margin-bottom: 4px; display:block;">Select Vehicle:</label>
      <select id="vehicleSelect" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; margin-bottom: 8px;">
        <option value="">-- Select Vehicle --</option>
      </select>
      <button onclick="showRoute()" style="width:100%; padding: 8px; margin-bottom: 4px; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">Show Route</button>
      <button onclick="optimizeRoute()" style="width:100%; padding: 8px; background:#10b981; color:white; border:none; border-radius:6px; cursor:pointer;">Optimize Route</button>
    </div>
  </div>

  <div class="map-container">
    <div id="map"></div>
    <div class="live-indicator">
      <div class="live-dot"></div>
      <span class="live-text">Live Tracking</span>
    </div>
    <div class="map-controls">
      <button onclick="zoomIn()">+</button>
      <button onclick="zoomOut()">âˆ’</button>
    </div>
  </div>

  <script>
    const API_URL = "https://dppzqfg20e.execute-api.ap-south-1.amazonaws.com/prod/vehicles";

    let map;
    let markers = {};
    let vehicles = [];
    let routePolyline = null;

    const destinations = [
      { lat: 12.975, lon: 77.591 },
      { lat: 12.972, lon: 77.595 },
      { lat: 12.969, lon: 77.600 }
    ];

    // Initialize map
    function initMap() {
      map = L.map('map').setView([12.9716, 77.5946], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
    }

    // Vehicle icon
    function createVehicleIcon(status) {
      const colors = { active:'#10b981', warning:'#f59e0b', critical:'#ef4444' };
      const color = colors[status] || colors.active;
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="position: relative;"><div style="background:${color};width:32px;height:32px;border-radius:50%;border:3px solid white;display:flex;align-items:center;justify-content:center;"></div></div>`,
        iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]
      });
    }

    function getStatus(vehicle){
      if(vehicle.fuel_percent<20) return 'critical';
      if(vehicle.fuel_percent<40 || vehicle.speed_kmh>80) return 'warning';
      return 'active';
    }

    // Update markers
    function updateMarkers(){
      vehicles.forEach(v=>{
        const status = getStatus(v);
        const pos=[v.latitude,v.longitude];
        if(markers[v.vehicle_id]){
          markers[v.vehicle_id].setLatLng(pos);
          markers[v.vehicle_id].setIcon(createVehicleIcon(status));
        } else {
          const marker=L.marker(pos,{icon:createVehicleIcon(status)}).addTo(map);
          markers[v.vehicle_id]=marker;
        }
      });
    }

    // Vehicle list
    function updateVehicleList(){
      const container=document.getElementById('vehicleList');
      if(vehicles.length===0){ container.innerHTML='<div class="empty-state">No vehicles found</div>'; return; }
      container.innerHTML=vehicles.map(v=>`
        <div class="vehicle-card" onclick="locateVehicle('${v.vehicle_id}')">
          <div class="vehicle-header">
            <div class="vehicle-info"><div class="vehicle-id">${v.vehicle_id}</div></div>
            <span class="status-badge status-${getStatus(v)}">${getStatus(v).toUpperCase()}</span>
          </div>
          <div class="timestamp">Updated: ${new Date(v.timestamp).toLocaleTimeString()}</div>
        </div>`).join('');
    }

    function updateStats(){
      const stats = {
        total: vehicles.length,
        active: vehicles.filter(v=>getStatus(v)==='active').length,
        warning: vehicles.filter(v=>getStatus(v)==='warning').length,
        critical: vehicles.filter(v=>getStatus(v)==='critical').length
      };
      document.getElementById('totalVehicles').textContent = stats.total;
      document.getElementById('activeVehicles').textContent = stats.active;
    }

    function updateVehicleSelect() {
      const select = document.getElementById('vehicleSelect');
      select.innerHTML = '<option value="">-- Select Vehicle --</option>';
      vehicles.forEach(v=>{
        const option=document.createElement('option');
        option.value=v.vehicle_id; option.textContent=v.vehicle_id;
        select.appendChild(option);
      });
    }

    async function fetchVehicles(){
      try{
        const res = await fetch(API_URL);
        if(!res.ok) throw new Error('Failed to fetch vehicles');
        const data = await res.json();
        const vehicleMap = new Map();
        (data.items || []).forEach(v=>{
          const existing = vehicleMap.get(v.vehicle_id);
          if(!existing || (v.timestamp && v.timestamp>existing.timestamp)) vehicleMap.set(v.vehicle_id,v);
        });
        vehicles=Array.from(vehicleMap.values());
        updateVehicleList(); updateStats(); updateMarkers(); updateVehicleSelect();
      } catch(e){
        console.error(e);
      }
    }

    function locateVehicle(vehicleId){
      const v=vehicles.find(v=>v.vehicle_id===vehicleId);
      if(v && markers[vehicleId]){
        map.setView([v.latitude,v.longitude],15);
      }
    }

    function zoomIn(){map.zoomIn();}
    function zoomOut(){map.zoomOut();}

    // --- Route functions ---
    function drawRoute(coords,color){
      if(routePolyline) map.removeLayer(routePolyline);
      routePolyline = L.polyline(coords,{color,weight:5,opacity:0.8}).addTo(map);
      map.fitBounds(routePolyline.getBounds(),{padding:[50,50]});
    }

    function showRoute(){
      const vehicleId=document.getElementById('vehicleSelect').value;
      if(!vehicleId) return alert("Select a vehicle");
      const v=vehicles.find(v=>v.vehicle_id===vehicleId);
      const coords=[[v.latitude,v.longitude],[destinations[0].lat,destinations[0].lon]];
      drawRoute(coords,'blue');
    }

    function optimizeRoute(){
      const vehicleId=document.getElementById('vehicleSelect').value;
      if(!vehicleId) return alert("Select a vehicle");
      const v=vehicles.find(v=>v.vehicle_id===vehicleId);
      const remaining=[...destinations];
      const routeCoords=[];
      let current={lat:v.latitude,lon:v.longitude};
      while(remaining.length>0){
        remaining.sort((a,b)=>{
          const da=(a.lat-current.lat)**2 + (a.lon-current.lon)**2;
          const db=(b.lat-current.lat)**2 + (b.lon-current.lon)**2;
          return da-db;
        });
        const next=remaining.shift();
        routeCoords.push([next.lat,next.lon]);
        current=next;
      }
      routeCoords.unshift([v.latitude,v.longitude]);
      drawRoute(routeCoords,'green');
    }

    // Initialize
    initMap();
    fetchVehicles();
    setInterval(fetchVehicles,5000);

  </script>
</body>
</html>
